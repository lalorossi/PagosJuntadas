<!DOCTYPE html>
<html>
<head>


    <link rel="stylesheet" href="css/style.css">

    <script>
    //Creo clases
    class Persona{
        constructor(nombre){
            this.nombre = nombre;
            this.comprasPorPersona = [];
        }
    }

    class Compra{
        constructor(producto, precio){
            this.producto = producto;
            this.precio = precio;
            this.cantCompras = 0;
        }
    }

    var cantPersonas = 1;

    //Agrega un input de compra o persona
    function agregar(cla) {

        var nuevo = document.createElement("tr");
        nuevo.className=cla;

        //Toma el primer elemento existente de la clase que quiero crear y copia el HTML a mi nuevo elemento
        var col = document.getElementsByClassName(cla);
        col = col[0].innerHTML;
        nuevo.innerHTML = col;

        //Si quiero agregar una compra, lo agreago a la pagina 1
        if(cla == "compra"){
            document.getElementById("page1").appendChild(nuevo);            
        }

        //Si es una persona, a la pagina 2
        if(cla == "persona"){
            document.getElementById("page2").appendChild(nuevo);    

            //Activa el boton de seleccion de compras para ser usado
            //Esto va a cambiar con el uso de "modals" (para mostrar las compras en una ventana)
            var td = document.getElementById("page2").getElementsByTagName("tr");
            td = td[td.length - 1];
            td = td.getElementsByTagName("td");
            td = td[td.length - 1];
            td = td.lastChild;
            td.id = "activado";
        }
    }


    function chau0(child)  {
        var grand = document.getElementById("page1");
        grand.removeChild(child.parentNode);
    }

    function chau(yo) {
    //Elimina el input de una compra/persona. Se activa con el boton de eliminar
        var papa=yo.parentNode.parentNode;
        papa.parentNode.removeChild(papa);
    }

    function checkSubmit(){
        //Checkea que se pueda pasar a la siguiente pagina viendo si al menos un campo de compra estÃ¡ completo
        //Por ahora solo funciona para pasar a la pagina 2, checkeando las compras
        var vacio = 0;
        compras = [];   //Notar que al no poner var, se hace global

        var rows = document.getElementsByClassName("compra");

        //Selecciona todas las compras y se fija si al menos una tiene todos los valores asignados
        for (var i = rows.length - 1; i >= 0; i--) {
            var celdas = rows[i].getElementsByTagName('input');

            if(celdas[0].value=="" || celdas[1].value=="" || celdas[1].value == 0){
            }
            else{
                //Cuando encuentra una compra completa la agrega al array de compras
                //compras.push([celdas[0].value, celdas[1].value]);
                var nuevaCompra = new Compra(celdas[0].value, celdas[1].value);
                compras.push(nuevaCompra);
                vacio=1;
            }
        }

        //Si encontro al menos una compra, pasa a la pagina2        
        if (vacio==1) {
            document.getElementById("pag2").style.display="";
            document.getElementById("pag1").style.display="none";
            return true;
        }
        else{
            window.alert("Ingrese al menos una compra con precio");
            return false;
        }

    }

    function mostrarCompras(yo){
        //Muestra las compras siempre que el boton de la persona este activado
        var checkbox;
        var txt;
        var div;

        //Borrar el modal y dejar el div modal-body vacio
        var modal = document.getElementsByClassName("modal-body")[0].getElementsByTagName('p');
        modal[0].parentNode.removeChild(modal[0]);
        modal = document.getElementsByClassName("modal-body")[0].getElementsByTagName('p');
        modal[0].parentNode.removeChild(modal[0]);

        if(yo.id == "activado"){
            //Busca los datos de las compras desde el array de compras
            //Hace una lista conm checkboxes para seleccionar las compras
            for (var i = compras.length - 1; i >= 0; i--) {
                div = document.createElement("div");
                checkbox = document.createElement("input");
                //txt = document.createTextNode(compras[i][0]);
                txt = document.createTextNode(compras[i].producto);


                checkbox.type = "checkbox";
                checkbox.className = "checkCompra";
                //checkbox.value = compras[i];    //No se bien por que hace esto
                checkbox.value = compras[i].producto;    //No se bien por que hace esto
                div.appendChild(checkbox);
                div.appendChild(txt);           //Adiciona el texto al lado del checkbox con el nombre de la compra

                //document.getElementById("pag2").appendChild(div);
                document.getElementsByClassName("modal-body")[0].appendChild(div);
            };

            //Crea el boton para confirmar la seleccion de compras
            var boton = document.createElement("input");
            boton.type = "button";
            boton.value = "OK";

            var personaParaActualizar = yo.parentNode.parentNode.getElementsByTagName("td")[1];
            personaParaActualizar = personaParaActualizar.getElementsByTagName('input')[0].value;
            //window.alert(personaParaActualizar);

            boton.onclick = function() { 
                actualizarPersona(personaParaActualizar);
            };

            //document.getElementById("pag2").appendChild(boton);       
            document.getElementsByClassName("modal-body")[0].appendChild(boton);

            var modal = document.getElementById("myModal");
            modal.style.display = "block";

            yo.id = "desactivado";      //Desactiva el boton para que no sea activado mas de una vez sin seleccionar compras
        }
    }

    var personas = [];

    //Cambiar para que guarde las compras en el array de la persona que apreto el boton
    function actualizarPersona(pers) {
        //var comprasXPers = [];
        //window.alert("HOLA");
        
        var pos;
        var boxes = document.getElementsByClassName("checkCompra");


        for (var i = boxes.length - 1; i >= 0; i--) {
            if(boxes[i].checked){
                //window.alert(boxes[i].value);       //Para comprobacion
                //Busco a la persona en el array de personas
                for (var o = personas.length - 1; o >= 0; o--) {
                    if (personas[o].nombre == pers) {
                        pos = o;
                    }
                }
                //window.alert(pos);
                personas[pos].comprasPorPersona.push([boxes[i].value])
            }
        };

        esconder();
        /*
        for (var i = personas[pos].comprasPorPersona.length - 1; i >= 0; i--) {
            window.alert(personas[pos].comprasPorPersona[i]);
        }
        */
        
    }

    function guardarPersona(nombre){
        if(nombre != ""){
            nuevaPersona = new Persona(nombre);
            personas.push(nuevaPersona);
            /*
            for (var i = personas.length - 1; i >= 0; i--) {
                window.alert(personas[i].nombre);
            }
            */
        }
    }

    function esconder(){
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
    }

    </script>
    <body>
    
</head>

<form action="upload.php" id="form" method="post" onsubmit="return checkSubmit()">
    <div id="pag1">
        <table id="page1">
            <tr class="compra">
                <td>Compra</td>
                <td><input type="text" name="concepto[]" id="concepto" placeholder="Compra"> </td>
                <td>$</td>
                <td><input type="number" name="precio[]" id="precio"></td>
                <!-- Boton de eliminar -->
                <td><button type="button" style="background-color: red; width: 25px" onclick="chau(this)">D</button></td>
            </tr>
        </table>
        <!-- Boton de agregar -->
        <input type="button" value="+" onclick='agregar("compra")'>

        <input type="button" value="Siguiente" onclick="checkSubmit()">
    </div>
    
    <div id="pag2"  style="display:none">
        <table id="page2">
            <tr class="persona">
                <td>Nombre</td>
                <td><input type="text" name="nombre[]" id="nombre1" placeholder="Nombre" onblur="guardarPersona(this.value)"> </td>
                <!-- Cuando se "sale" del input, se guarda la persona -->
                <td><input type="button" id="activado" onclick="mostrarCompras(this)"></td>
            </tr>
        </table>
        <input type="button" value="+" onclick='agregar("persona")'>

        
        <br></br>

        <!-- Para agregar la seleccion de compras -->
        <div id="select">
        </div>

        <!-- The Modal -->
        <div id="myModal" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
              <div class="modal-header">
                <span class="close" onclick="esconder()">&times;</span>
                <h2>Modal Header</h2>
              </div>
              <div class="modal-body">
                <p>Some text in the Modal Body</p>
                <p>Some other text...</p>
              </div>
              <div class="modal-footer">
                <h3>Modal Footer</h3>
              </div>
            </div>
        </div>

        <input type="submit" id="botonSubmit" value="Siguiente" name="submit">
    </div>
</form>


</body>
</html>

